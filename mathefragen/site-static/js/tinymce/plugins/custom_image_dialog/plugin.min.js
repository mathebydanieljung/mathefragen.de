tinymce.PluginManager.add('custom_image_dialog', function (editor, url) {
    var openDialog = function () {
        return editor.windowManager.open({
            title: 'Bild hochladen',
            body: {
                type: 'panel',
                items: [
                    {
                        type: 'dropzone',
                        name: 'uploaded_file',
                        text: 'Bild hochladen',
                    }
                ]
            },
            onChange(api, image) {
                var data = api.getData();
                var file = data.uploaded_file[0];
                var form_data = new FormData();
                form_data.append('file', file, file.name);
                form_data.append('csrfmiddlewaretoken', csrf_token);

                $('.tox-dropzone').empty();

                var animation_img = document.createElement('img');
                animation_img.src = loading_img_src;

                $('.tox-dropzone').append(animation_img);

                $.ajax({
                    url: urls.upload_image_url,
                    type: 'post',
                    data: form_data,
                    processData: false,
                    contentType: false,
                }).done(function (response) {
                    var data = api.getData();
                    console.log('response: ', response);
                    data.uploaded_file[0] = JSON.parse(response).location;

                    // adjust preview image
                    animation_img.src = '';
                    animation_img.style.width = '424px';
                    animation_img.style.height = 'auto';
                    animation_img.src = JSON.parse(response).location;
                }).fail(function (err) {
                    console.log('err: ', err);
                    if (err.responseText === 'not_safe_for_work'){
                        alert('Das Bild enthält unsicheren Inhalt.')
                    } else {
                        alert('Oops, versuch nochmal.');
                    }
                    api.close();
                });

            },
            buttons: [{
                type: 'submit',
                name: 'Einfügen',
                text: 'Einfügen'
            }],
            onSubmit(api) {
                var data = api.getData();
                var uploaded_url = data.uploaded_file[0];
                editor.insertContent('<img src="' + uploaded_url + '" width="50%" class="fit_width" />');
                api.close();
            }
        });
    };

    // Add a button that opens a window
    editor.ui.registry.addButton('custom_image_dialog', {
        icon: 'image',
        onAction: function () {
            // Open window
            openDialog();
        }
    });

    // Adds a menu item, which can then be included in any menu via the menu/menubar configuration
    editor.ui.registry.addMenuItem('custom_image_dialog', {
        text: 'Bild hochladen',
        onAction: function () {
            // Open window
            openDialog();
        }
    });

    return {
        getMetadata: function () {
            return {
                name: "Bild hochladen"
            };
        }
    };

});
